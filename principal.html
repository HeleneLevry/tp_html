<!-- principal -->


<!DOCTYPE html>


<html lang="en">


<head>

	<meta charset="utf-8" />
	<link rel="stylesheet" href="TP_HTML5.css" />
	<title>SnapShot</title>

	<script type="text/javascript">
	</script>

</head>


<body>

	<!-- Conteneur -->
	<div id="conteneur">

		<!-- Title-->
		<h1>SnapShot</h1>
		<hr/>

		<!-- Elements-->
		<video style="display:none;" id="video" autoplay></video>
		<img id="target" src="target.png">

		<div class="element">
			<canvas id="canvasWebcam" style="">
				Texte alternatif pour les navigatuers ne supportant pas canvas.
			</canvas>
			<img id="myImage" src="" style="display:none;">
		</div>

		<!-- Script onload -->
		<script type="text/javascript">

		// height 100% navigator ---------------
		function height(bloc){
			var hauteur;
			if( typeof( window.innerWidth ) == 'number' ){
				hauteur = window.innerHeight;
			}
			else if( document.documentElement && document.documentElement.clientHeight ){
				hauteur = document.documentElement.clientHeight;
			}
    		document.getElementById(bloc).style.height = hauteur+"px";
    	}

		// On load
		window.onload = function(){

			// height ---------------
			//height("conteneur");

			// Declarations ---------------
			// Elements
			var canvasWebcam = document.getElementById("canvasWebcam");
			var video = document.getElementById('video');
			var myImage = document.getElementById('myImage');
			var img_target = document.getElementById('target');
			// Size
			var size_img = 100;
			var size_img_2 = size_img/2;
			// Image target
			/*var img_target = new Image();
			img_target.src = "target.png";
			img_target.width = size_img;
			img_target.height = size_img;*/
			// window URL
			window.URL = window.URL || window.webkitURL;
			// getUSerMedia
			navigator.getUserMedia = (navigator.getUserMedia ||
				navigator.webkitGetUserMedia ||
				navigator.mozGetUserMedia ||
				navigator.msGetUserMedia);

			// Canvas ---------------
			// Get canvas
			if (!canvasWebcam){
				alert("Impossible to get the canvas");
				return;
			}
			canvasWebcam.width = 650;
			canvasWebcam.height = 500;
			canvasCenterW = canvasWebcam.width/2;
			canvasCenterH = canvasWebcam.height/2;
			// Context of the canvas
			var ctx = canvasWebcam.getContext("2d");
			if (!ctx){
				alert("Impossible to get the context");
				return;
			}
			
			// CanvasPlayer
			function canvasPlayer(){
				if (myStream) {
					ctx.drawImage(video, 0, 0, canvasWebcam.width, canvasWebcam.height);
					// Add the target at the center
					ctx.drawImage(img_target,canvasCenterW-size_img_2,canvasCenterH-size_img_2,size_img,size_img);     
					ctx.fill();         
				}
			}

			// Video ---------------
			if (navigator.getUserMedia){
				navigator.getUserMedia(
				{
					video: true, audio: false
				}, 
				function(stream){
					if (navigator.mozGetUserMedia) {
						video.mozSrcObject = stream;
					} else {
						video.src = window.URL.createObjectURL(stream);
					}
					video.play();
					myStream = stream;
					window.setInterval(canvasPlayer, 10);
				},
				function(err){
					console.log("Error :" + err);
				}
				);
			}
			else {
				alert('Your browser does not support getUSerMedia');
			}
		}

		// On resize
		//window.onresize = function(){ height("conteneur") };

		</script>

		<!-- Fields -->
		<div id="geolocation" class="element" style="display:none;">
			<div class="element"> 
				<p id="latitude"></p>
				<p id="longitude"></p>
			</div>
			<div class="element">
				<p id="dat"></p>
				<p id="time"></p>
			</div>
		</div>	


		<!-- Buttons -->
		<div class="element" id ="buttons">
			<button id="save" onclick="save()">Save</button>
			<button id="shoot" onclick="shoot()">Shoot</button>
			<button id="reset" onclick="reset()">Reset</button>
		</div>  
		<!-- Script buttons' actions -->
		<script>

		// Declarations ---------------
		var geoloc = document.getElementById("geolocation");
		var latitude = document.getElementById("latitude");
		var longitude = document.getElementById("longitude");
		var dat = document.getElementById("dat");
		var time = document.getElementById("time");

		// getLocation ---------------
		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(showPosition);
			}
			else {
				geoloc.innerHTML="Geolocation is not supported by this browser.";
			}
		}

		// showPosition (and datetime) ---------------
		function showPosition(position) {
			var date = new Date();
			geoloc.style="display:flex;";
			latitude.innerHTML="Latitude: " + position.coords.latitude;
			longitude.innerHTML="Longitude: " + position.coords.longitude;
			dat.innerHTML="Date: " + date.getDate()+"/"+(date.getMonth()+1)+"/"+date.getFullYear();
			time.innerHTML="Time: " + date.getHours()+":"+date.getMinutes();     
		}
		// snapshot ---------------
		function snapshot(){
			if (myStream) {
				canvasWebcam.style="display:none;"
				myImage.src = canvasWebcam.toDataURL('myImage/webp');
				myImage.style="display:flex;";
			}
		}

		// shoot ---------------
		function shoot(){
			getLocation();
			snapshot();
		}

		// reset ---------------
		function reset(){
			canvasWebcam.style="display:flex;"
			myImage.style="display:none;"
			geoloc.style="display:none;";
		}

		function save(){
			this.href= myImage;
			this.download = "test.png";

		}

		// Filter by pixel
					/*var currentImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
					var pixels = currentImage.data;
	          // iterate over all pixels
	          for(var i = 0, n =r pixels.length; i < n; i += 4) {
	            pixels[i + 0] = 0; // red
	            //pixels[i + 1] = 0; // green
	            //pixels[i + 2] = 0; // blue
	            //pixels[i + 3] = 0; // alpha           
	          }
	          ctx.putImageData(currentImage,0, 0);*/

		</script>

	</div>

</body>


