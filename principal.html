<!-- principal -->

<!DOCTYPE html>

<html lang="en">


<head>

	<meta charset="utf-8" />
	<link rel="stylesheet" href="TP_HTML5.css" />
	<title>SnapShot</title>

	<script type="text/javascript">
	</script>

</head>


<body>

	<!-- Title-->
	<h1>SnapShot</h1>
	<hr/>

	<!-- Elements-->
	<video style="display:none;" id="video" autoplay></video>
	<canvas id="canvasWebcam" style="">
		Texte alternatif pour les navigatuers ne supportant pas canvas.
	</canvas>
	<img id="myImage" src="">  

	<script type="text/javascript">

	// On load
	window.onload = function(){

		// Declarations ---------------
		// Elements
		var canvasWebcam = document.getElementById("canvasWebcam");
		var video = document.getElementById('video');
		var myImage = document.getElementById('myImage');
		// Size
		var size_img = 100;
		var size_img_2 = size_img/2;
		// Image target
		var img_target = new Image();
		img_target.src = "target.png";
		img_target.width = size_img;
		img_target.height = size_img;
		// window URL
		window.URL = window.URL || window.webkitURL;
		// getUSerMedia
		navigator.getUserMedia = (navigator.getUserMedia ||
			navigator.webkitGetUserMedia ||
			navigator.mozGetUserMedia ||
			navigator.msGetUserMedia);

		// Canvas ---------------
		// Get canvas
		if (!canvasWebcam){
			alert("Impossible to get the canvas");
			return;
		}
		canvasWebcam.width = 650;
		canvasWebcam.height = 500;
		canvasCenterW = canvasWebcam.width/2;
		canvasCenterH = canvasWebcam.height/2;
		// Context of the canvas
		var ctx = canvasWebcam.getContext("2d");
		if (!ctx){
			alert("Impossible to get the context");
			return;
		}
		

		// CanvasPlayer ---------------
		function canvasPlayer(){
			if (myStream) {
				ctx.drawImage(video, 0, 0, canvasWebcam.width, canvasWebcam.height);
				// Add the target at the center
				ctx.drawImage(img_target,canvasCenterW-size_img_2,canvasCenterH-size_img_2,size_img,size_img);
				// Filter with fillRect
				// ctx.fillStyle = 'rgba(118, 174,42, 0.2)';
				// ctx.fillRect(0,0,canvasWebcam.width,canvasWebcam.height);
				// Filter by pixel
				/*var currentImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
				var pixels = currentImage.data;
          // iterate over all pixels
          for(var i = 0, n = pixels.length; i < n; i += 4) {
            pixels[i + 0] = 0; // red
            //pixels[i + 1] = 0; // green
            //pixels[i + 2] = 0; // blue
            //pixels[i + 3] = 0; // alpha           
          }
          ctx.putImageData(currentImage,0, 0);*/     
          ctx.fill();         
        }
      }


  	

  	//video.addEventListener('click', snapshot, false);

		// Video
		if (navigator.getUserMedia){
			navigator.getUserMedia(
			{
				video: true, audio: false
			}, 
			function(stream){
				if (navigator.mozGetUserMedia) {
					video.mozSrcObject = stream;
				} else {
					video.src = window.URL.createObjectURL(stream);
				}
				video.play();
				myStream = stream;
				window.setInterval(canvasPlayer, 10);
			},
			function(err){
				console.log("Error :" + err);
			}
			);
		}
		else {
			alert('Your browser does not support getUSerMedia');
		}
	}

	</script>
	<br/>
	<div id="geolocation" style=""></div>

	
	<button id="save" onclick="">Save</button>
	<button id="shoot" onclick="shoot()">Shoot</button>

	<button id="reset" onclick="reset()">Reset</button>
	<script>
		var x = document.getElementById("geolocation");        
		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(showPosition);
			}
			else {
				x.innerHTML="Geolocation is not supported by this browser.";
			}
		}
		function showPosition(position) {
			var date = new Date();
			x.style="display:flex;";
			x.innerHTML="Latitude: " + position.coords.latitude + "<br/>Longitude: " + position.coords.longitude+"<br/>Date/Time: "+date.getDate()+"/"+(date.getMonth()+1)+"/"+date.getFullYear()+"\t"+date.getHours()+":"+date.getMinutes();       
		}
		// Snapshot
  		function snapshot(){
	  		if (myStream) {
	  			canvasWebcam.style="display:none;"
	  			myImage.src = canvasWebcam.toDataURL('myImage/webp');
	  			myImage.style="display:flex;";
	  		}
	  	}

		function shoot(){
			getLocation();
			snapshot();
		}

		function reset(){
			canvasWebcam.style="display:flex;"
			myImage.style="display:none;"
			x.style="display:none;";
		}
	</script>
</body>